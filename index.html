<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Erth-Style Poker Demo — Multiplayer (Local)</title>
    <style>
        :root {
            --bg: #0b0f13;
            --panel: rgba(255, 255, 255, 0.04);
            --accent: #2fe6a8;
        }
        * {
            box-sizing: border-box;
        }
        body {
            margin: 0;
            min-height: 100vh;
            overflow-x: hidden;
            background: linear-gradient(180deg, #051018, #07121a);
            font-family: Inter, Segoe UI, Helvetica, Arial, sans-serif;
            color: #e8f6ef;
        }
        .app {
            display: grid;
            grid-template-columns: 300px 1fr 320px;
            gap: 12px;
            padding: 14px;
            min-height: 100vh;
        }
        .panel {
            background: var(--panel);
            padding: 12px;
            border-radius: 12px;
            backdrop-filter: blur(6px);
        }
        h3 {
            margin: 8px 0;
        }
        button {
            background: linear-gradient(135deg, #4e9eff, #1e6fff);
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            color: white;
            cursor: pointer;
        }
        .small {
            color: #9fb6ad;
            font-size: 13px;
        }
        .table-card {
            padding: 10px;
            border-radius: 10px;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), transparent);
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .table-area {
            display: flex;
            flex-direction: column;
            min-height: 100%;
            height: auto;
        }
        .table-stage {
            flex: 1;
            min-height: 420px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        .felt {
            width: 760px;
            height: 420px;
            border-radius: 220px;
            background: radial-gradient(circle at 50% 25%, #0b6b2e, #06401f);
            box-shadow: 0 16px 50px rgba(0, 0, 0, 0.6);
            position: relative;
        }
        .community {
            position: absolute;
            left: 50%;
            top: 40%;
            transform: translate(-50%, -50%);
            display: flex;
            gap: 10px;
        }
        .card-ui {
            width: 64px;
            height: 92px;
            border-radius: 8px;
            background: white;
            color: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
        }
        .seats {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            height: 100%;
        }
        .seat {
            position: absolute;
            width: 120px;
            text-align: center;
        }
        .seat .chips {
            margin-top: 6px;
            font-weight: 700;
        }
        .seat .chip-stack {
            width: 54px;
            height: 28px;
            background: linear-gradient(90deg, #f6c84c, #e69b2b);
            border-radius: 14px;
            margin: 6px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #072017;
            font-weight: 800;
        }
        .controls {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-top: 10px;
        }
        input[type=number] {
            padding: 8px;
            border-radius: 8px;
            border: none;
            width: 120px;
        }
        .chat {
            max-height: 200px;
            overflow: auto;
            background: rgba(0, 0, 0, 0.12);
            padding: 8px;
            border-radius: 8px;
        }
        @media (max-width: 1100px) {
            .app {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="app">
        <aside class="panel">
            <h3>Lobby</h3>
            <div class="lobby-controls">
                <input id="newTblName" placeholder="Table name" class="input-table-name" />
                <button id="createTbl">Create</button>
            </div>
            <div id="lobbyList"></div>
            <hr />
            <div class="small">Tip: Open this page in multiple tabs to simulate real multiplayer — tables sync locally via <code>localStorage</code>.</div>
        </aside>

        <main class="panel table-area">
            <div class="table-header">
                <div>
                    <h3 id="tableTitle">No table selected</h3>
                    <div class="small" id="tableSub">Join or create a table</div>
                </div>
                <div>
                    <div class="small">Pot: <strong id="pot">0</strong></div>
                </div>
            </div>

            <div class="table-stage">
                <div class="felt" id="felt">
                    <div class="community" id="community"></div>
                    <div class="seats" id="seats"></div>
                </div>
            </div>

            <div class="controls">
                <input type="number" id="betAmount" min="1" step="1" value="50" />
                <button id="btnBet">Bet / Call</button>
                <button id="btnCheck">Check</button>
                <button id="btnFold">Fold</button>
                <button id="btnDeal">Deal</button>
            </div>

            <div class="panel chat-panel">
                <h4>Chat</h4>
                <div class="chat" id="chat"></div>
                <input id="chatInput" placeholder="Message (Enter to send)" class="input-chat" />
            </div>

            <aside class="player-profile">
                <div class="panel">
                    <h4>Your Profile</h4>
                    <div class="profile-info">
                        <div class="avatar" id="avatar">Y</div>
                        <div>
                            <div><strong id="playerName">You</strong></div>
                            <div class="small">Chips: <strong id="yourChips">1000</strong></div>
                            <div class="small">Seat: <span id="yourSeat">—</span></div>
                        </div>
                    </div>
                </div>

                <div class="panel">
                    <h4>Table Players</h4>
                    <div id="playersList"></div>
                </div>
            </aside>
        </main>

        <aside class="panel">
            <h3>Tables</h3>
            <div id="tablesList"></div>
            <hr />
            <div class="small">Tables are stored in localStorage. Open multiple tabs to see live updates.</div>
        </aside>
    </div>

    <script>
        const STORAGE_KEY = 'poker_tables_v1';
        let playerId = 'p_' + Math.random().toString(36).slice(2, 9);
        let displayName = localStorage.getItem('poker_name') || 'You';
        let myChips = parseInt(localStorage.getItem('poker_chips') || '1000');
        let currentTableId = null;
        const seatsPerTable = 6;

        // UI refs
        const lobbyList = document.getElementById('lobbyList');
        const tablesList = document.getElementById('tablesList');
        const tableTitle = document.getElementById('tableTitle');
        const tableSub = document.getElementById('tableSub');
        const seatsEl = document.getElementById('seats');
        const playersList = document.getElementById('playersList');
        const communityEl = document.getElementById('community');
        const potEl = document.getElementById('pot');
        const yourChipsEl = document.getElementById('yourChips');
        const yourSeatEl = document.getElementById('yourSeat');
        const chatEl = document.getElementById('chat');
        const chatInput = document.getElementById('chatInput');
        const betInput = document.getElementById('betAmount');

        // Initialize
        renderLobby();
        renderTablesList();
        refreshProfile();

        // Storage helpers
        const readTables = () => {
            try {
                return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            } catch (e) {
                console.error("Error reading tables from localStorage:", e);
                return [];
            }
        };

        const writeTables = (tables) => {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(tables));
        };

        const renderLobby = () => {
            const tables = readTables();
            lobbyList.innerHTML = '';
            tables.forEach(table => {
                const div = document.createElement('div');
                div.className = 'table-card';
                div.innerHTML = `
                    <div>
                        <strong>${table.name}</strong>
                        <div class="small">${table.mode} • ${table.seats.filter(s => s).length}/${seatsPerTable}</div>
                    </div>
                    <div>
                        <button data-id="${table.id}">Join</button>
                    </div>`;
                lobbyList.appendChild(div);
            });
            lobbyList.querySelectorAll('button').forEach(button =>
                button.addEventListener('click', e => joinTable(e.target.dataset.id))
            );
        };

        // Create table
        document.getElementById('createTbl').addEventListener('click', () => {
            const name = document.getElementById('newTblName').value.trim() || `Table ${Date.now() % 1000}`;
            const tables = readTables();
            const id = 't_' + Math.random().toString(36).slice(2, 8);
            const seats = Array(seatsPerTable).fill(null);
            const table = { id, name, mode: 'Texas Hold\'em', seats, pot: 0, community: [], deck: [], stage: 'idle' };
            tables.push(table);
            writeTables(tables);
            renderLobby();
            renderTablesList();
            document.getElementById('newTblName').value = '';
        });

        const renderTablesList = () => {
            const tables = readTables();
            tablesList.innerHTML = '';
            tables.forEach(table => {
                const div = document.createElement('div');
                div.className = 'table-card';
                div.innerHTML = `
                    <div>
                        <strong>${table.name}</strong>
                        <div class="small">${table.seats.filter(s => s).length}/${seatsPerTable} seats</div>
                    </div>
                    <div style="display:flex;flex-direction:column;gap:6px">
                        <button data-id="${table.id}" class="joinBtn">Join</button>
                        <button data-id="${table.id}" class="spectateBtn">Spectate</button>
                    </div>`;
                tablesList.appendChild(div);
            });
            tablesList.querySelectorAll('.joinBtn').forEach(button =>
                button.addEventListener('click', e => joinTable(e.target.dataset.id))
            );
            tablesList.querySelectorAll('.spectateBtn').forEach(button =>
                button.addEventListener('click', e => spectateTable(e.target.dataset.id))
            );
        };

        const refreshProfile = () => {
            document.getElementById('playerName').innerText = displayName;
            yourChipsEl.innerText = myChips;
        };

        // Join table: seat the player in the first empty seat
        const joinTable = (id) => {
            const tables = readTables();
            const table = tables.find(t => t.id === id);
            if (!table) return alert('Table not found');

            let seatIndex = table.seats.findIndex(s => s && s.id === playerId);
            if (seatIndex === -1) {
                seatIndex = table.seats.findIndex(s => !s);
                if (seatIndex === -1) return alert('Table full');
                table.seats[seatIndex] = { id: playerId, name: displayName, chips: myChips };
            }
            writeTables(tables);
            currentTableId = id;
            renderTable();
        };

        const spectateTable = (id) => {
            currentTableId = id;
            renderTable();
        };

        // Render selected table
        const renderTable = () => {
            const tables = readTables();
            const table = tables.find(t => t.id === currentTableId);
            if (!table) {
                tableTitle.innerText = 'No table selected';
                tableSub.innerText = 'Join or create a table';
                seatsEl.innerHTML = '';
                playersList.innerHTML = '';
                communityEl.innerHTML = '';
                potEl.innerText = '0';
                yourSeatEl.innerText = '—';
                return;
            }
            tableTitle.innerText = table.name;
            tableSub.innerText = table.mode;
            potEl.innerText = table.pot;

            // Clear previous seats and players
            seatsEl.innerHTML = '';
            playersList.innerHTML = '';
            communityEl.innerHTML = '';

            // Render seats
            table.seats.forEach((seat, index) => {
                const div = document.createElement('div');
                div.className = 'seat';
                const angle = (index / seatsPerTable) * Math.PI * 2 - Math.PI / 2;
                const rx = 300, ry = 150;
                const x = 380 + Math.cos(angle) * rx - 60;
                const y = 210 + Math.sin(angle) * ry - 40;
                div.style.left = `${x}px`;
                div.style.top = `${y}px`;

                if (seat) {
                    const cards = seat.hand ? seat.hand.map(c => `<div class='card-ui'>${c}</div>`).join('') : '';
                    div.innerHTML = `
                        <div><strong>${seat.name}</strong></div>
                        <div style='display:flex;gap:6px;justify-content:center;margin-top:4px'>${cards}</div>
                        <div class="chip-stack">${seat.chips}</div>
                        <div class="small">Seat ${index + 1}</div>`;
                } else {
                    div.innerHTML = `<div class="small">Empty</div><div style="margin-top:6px"><button data-seat="${index}">Sit</button></div>`;
                }
                seatsEl.appendChild(div);
            });

            // Bind sit buttons
            seatsEl.querySelectorAll('button').forEach(button =>
                button.addEventListener('click', e => sitAt(currentTableId, Number(e.target.dataset.seat)))
            );

            // Players list
            table.seats.forEach((seat, index) => {
                const playerDiv = document.createElement('div');
                playerDiv.style.padding = '6px 0';
                playerDiv.innerHTML = seat ? `<strong>${seat.name}</strong> — ${seat.chips} chips (Seat ${index + 1})` : `<span class="small">Empty Seat ${index + 1}</span>`;
                playersList.appendChild(playerDiv);
                if (seat && seat.id === playerId) yourSeatEl.innerText = index + 1;
            });

            // Community cards
            table.community.forEach(card => {
                const cardEl = document.createElement('div');
                cardEl.className = 'card-ui';
                cardEl.textContent = card;
                communityEl.appendChild(cardEl);
            });
        };

        const sitAt = (tableId, seatIndex) => {
            const tables = readTables();
            const table = tables.find(t => t.id === tableId);
            if (!table) return;
            if (table.seats[seatIndex]) return alert('Seat taken');
            table.seats[seatIndex] = { id: playerId, name: displayName, chips: myChips };
            writeTables(tables);
            renderTable();
        };

        // Deal logic (simplified)
        const buildDeck = () => {
            const ranks = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
            const suits = ['♠', '♥', '♣', '♦'];
            const deck = [];
            for (const rank of ranks) {
                for (const suit of suits) {
                    deck.push(rank + suit);
                }
            }
            return shuffle(deck);
        };

        const shuffle = (array) => {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        };

        document.getElementById('btnDeal').addEventListener('click', () => {
            if (!currentTableId) return alert('Join a table first');
            const tables = readTables();
            const table = tables.find(t => t.id === currentTableId);
            if (!table) return;

            // Create deck and deal two cards to seated players
            const deck = buildDeck();
            table.deck = deck;
            table.community = [];
            table.pot = 0;
            table.stage = 'pre';
            table.seats = table.seats.map(seat => seat ? { ...seat, hand: [deck.pop(), deck.pop()] } : null);
            writeTables(tables);
            renderTable();
            broadcastChat('Dealer: Dealt a new hand.');
        });

        // Betting
        document.getElementById('btnBet').addEventListener('click', () => {
            const amount = Math.max(1, Math.floor(Number(betInput.value) || 0));
            if (!currentTableId) return alert('Join a table');
            const tables = readTables();
            const table = tables.find(t => t.id === currentTableId);
            if (!table) return;

            const seatIndex = table.seats.findIndex(seat => seat && seat.id === playerId);
            if (seatIndex === -1) return alert('You must sit to bet');
            const seat = table.seats[seatIndex];
            if (seat.chips < amount) return alert('Not enough chips');
            seat.chips -= amount;
            table.pot += amount; // Record bet
            writeTables(tables);
            renderTable();
            updateLocalChips(seat.chips);
            broadcastChat(`${seat.name} bets ${amount}`);
        });

        document.getElementById('btnCheck').addEventListener('click', () => {
            if (!currentTableId) return;
            broadcastChat(`${displayName} checks`);
        });

        document.getElementById('btnFold').addEventListener('click', () => {
            if (!currentTableId) return;
            broadcastChat(`${displayName} folds`);
        });

        // Chat functionality
        chatInput.addEventListener('keydown', e => {
            if (e.key === 'Enter') {
                const message = chatInput.value.trim();
                if (!message) return;
                broadcastChat(`${displayName}: ${message}`);
                chatInput.value = '';
            }
        });

        const broadcastChat = (message) => {
            const time = new Date().toLocaleTimeString();
            const entry = `${time} — ${message}`;
            const tables = readTables();
            const table = tables.find(t => t.id === currentTableId);
            if (!table) return;
            table.chat = table.chat || [];
            table.chat.push(entry);
            if (table.chat.length > 200) table.chat.shift();
            writeTables(tables);
            renderChat(table.chat);
        };

        const renderChat = (chatArray) => {
            chatEl.innerHTML = '';
            (chatArray || []).forEach(chat => {
                const div = document.createElement('div');
                div.textContent = chat;
                chatEl.appendChild(div);
            });
            chatEl.scrollTop = chatEl.scrollHeight;
        };

        const updateLocalChips = (newChips) => {
            myChips = newChips;
            localStorage.setItem('poker_chips', String(myChips));
            refreshProfile();
        };

        // Listen for storage changes to sync across tabs
        window.addEventListener('storage', (event) => {
            if (event.key === STORAGE_KEY) {
                renderLobby();
                renderTablesList();
                renderTable();
            }
        });

        // Auto-select first table if exists
        setTimeout(() => {
            const tables = readTables();
            if (tables.length && !currentTableId) {
                currentTableId = tables[0].id;
                renderTable();
            }
        }, 200);
    </script>
</body>
</html>
